{% extends 'nmgfams_app/base.html' %}
{% load static %}
{% block content %}

{% include 'nmgfams_app/filter_cards.html'%}
<div v-if='totalItems == 0' class='h-100'>
    {% include 'nmgfams_app/example_cards.html'%}
</div>

<div v-if='totalItems > 0'
    class='text-center mb-3'>
    Showing results from [[ (currentPage - 1) * perPage + 1 ]] 
    to [[ Math.min(currentPage * perPage, totalItems) ]]. Total hits: [[ totalItems ]].
</div>
<div v-if="nPages > 1">
    {% include 'nmgfams_app/pagination.html' with currentPage=currentPage nPages=nPages field="f" only %}
</div>

<div v-for="(tdata, tid, index) in show_items">               
    {% include 'nmgfams_app/card.html' %}
</div>
<div v-if="nPages > 1 && Object.keys(show_items).length > 3">
    {% include 'nmgfams_app/pagination.html' %}
</div>
{% endblock %}
{% block scripts %}
    <script src="{% static "nmgfams_app/assets/tabler/libs/nouislider/distribute/nouislider.min.js" %}"></script>
    <script src="{% static "nmgfams_app/js/SeqSunburst.js" %}"></script>
    <script src="{% static "nmgfams_app/js/gecoviz.js" %}"></script>
    <script src="{% static "nmgfams_app/js/FileSaver.js" %}"></script>
    <script src="{% static "nmgfams_app/js/gmgc.js" %}"></script>
    <script charset="utf-8">
      $(document).ready(function () {
          $(".form-help").popover();
          let searchType = document.getElementById('search-type');
          let choices = new Choices(searchType, {
            classNames: {
                containerInner: searchType.className,
                input: 'form-control',
                inputCloned: 'form-control-sm',
                listDropdown: 'dropdown-menu',
                itemChoice: 'dropdown-item',
                activeState: 'show',
                selectedState: 'active',
                placeholder: 'choices__placeholder',
            },
            shouldSort: false,
            searchEnabled: false,
            choices : [
                { value: 'fam', label: 'Family name', selected: true },
                { value: 'taxa', id: 'taxa', label: 'Taxon name' },
                { value: 'function', label: 'Functional context' },
                { value: 'biome', label: 'Biome name' },
            ]
          });
          searchType = $('#search-type')
          searchType.change(async function(){
            await $('.search-filters').collapse('hide');
            let val = searchType.val();
            if (val == 'taxa') {
                await $('#taxa-filters').collapse('show');
            } else if (val == 'function') {
                await $('#function-filters').collapse('show');
            }
          });
          ["specificity", "coverage", "conservation"].forEach(id => {
                let slider = document.getElementById(id);
                noUiSlider.create(slider,
                    {
                        start: .9,
                        connect: [true, false],
                        step: .01,
                        range: {
                            min: 0,
                            max: 1
                            }
                    });
                let sliderLabel = d3.select(`.${id} label`);
                slider = slider.noUiSlider;
                slider.on('update', () => {
                    let name =  id.trim().replace(/^\w/, c => c.toUpperCase());
                    sliderLabel.html(name+': '+slider.get());
                })
          })
          let slider = document.getElementById("mindist");
          noUiSlider.create(slider,
                {
                    start: 1,
                    connect: [true, false],
                    step: 1,
                    range: {
                        min: 0,
                        max: 2
                        }
                });
            let sliderLabel = d3.select(`.mindist label`);
            slider = slider.noUiSlider;
            slider.on('update', () => {
                let name =  "Min relative distance";
                sliderLabel.html(`${name}: ${parseInt(slider.get())} gene(s)`);
            })
      });
    </script>
{% endblock %}
